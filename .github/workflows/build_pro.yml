name: ğŸš€ LiquidSnap Ultimate CI/CD Pipeline (Pro Max)

# ==============================================================================
# ğŸ¯ TRIGGERS (Ù…ØªÙ‰ ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ­Ø´ØŸ)
# ==============================================================================
on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø¶ØºØ·Ø© Ø²Ø±

# ==============================================================================
# âš™ï¸ GLOBAL CONFIGURATION (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©)
# ==============================================================================
env:
  FLUTTER_CHANNEL: 'stable'
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  PROPERTIES_PATH: './android/local.properties'

# ==============================================================================
# ğŸ—ï¸ JOBS (Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØ©)
# ==============================================================================
jobs:
  # ----------------------------------------------------------------------------
  # JOB 1: QUALITY ASSURANCE (ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ÙƒÙˆØ¯)
  # ----------------------------------------------------------------------------
  analyze_and_test:
    name: ğŸ” Code Analysis & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: âš¡ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ§ Analyze Code (Static Analysis)
        run: flutter analyze
        continue-on-error: true # Ù„Ù† Ù†ÙˆÙ‚Ù Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø³Ø¨Ø¨ ØªØ­Ø°ÙŠØ±Ø§Øª Ø¨Ø³ÙŠØ·Ø©

      - name: ğŸ§ª Run Unit Tests (Optional)
        run: flutter test || echo "No tests found, skipping..."

  # ----------------------------------------------------------------------------
  # JOB 2: BUILD ENVIRONMENT PREP (ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØµØ§Ø±Ù…Ø©)
  # ----------------------------------------------------------------------------
  prepare_environment:
    name: ğŸ› ï¸ Prepare Android Environment
    needs: analyze_and_test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ§¹ Deep Clean Project
        run: |
          flutter clean
          rm -rf build
          rm -rf android/.gradle
          flutter pub get

      - name: ğŸ“„ Create local.properties
        run: |
          echo "flutter.sdk=$FLUTTER_ROOT" > ${{ env.PROPERTIES_PATH }}
          echo "sdk.dir=$ANDROID_HOME" >> ${{ env.PROPERTIES_PATH }}
          echo "flutter.buildMode=debug" >> ${{ env.PROPERTIES_PATH }}

  # ----------------------------------------------------------------------------
  # JOB 3: BUILD THE BEAST (Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø©)
  # ----------------------------------------------------------------------------
  build_apk_debug_universal:
    name: ğŸ—ï¸ Build Universal Debug APK (The Beast)
    needs: prepare_environment
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Ù†Ø¹Ø·ÙŠÙ‡ ÙˆÙ‚Øª ÙƒØ§ÙÙŠ Ù„Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¶Ø®Ù…
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù€ Universal (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª)
      # --debug: ÙŠØ¶Ù…Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¹Ù‚Ø¯
      # --no-shrink: ÙŠÙ…Ù†Ø¹ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª
      - name: ğŸ”¨ Build Universal APK (Debug Mode)
        run: |
          flutter build apk --debug --no-shrink

      - name: ğŸ“¤ Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-Universal-Debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 14

  # ----------------------------------------------------------------------------
  # JOB 4: BUILD OPTIMIZED SPLITS (Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø® Ù…ØªØ®ØµØµØ© Ù„ÙƒÙ„ Ù…Ø¹Ø§Ù„Ø¬)
  # ----------------------------------------------------------------------------
  build_apk_splits:
    name: ğŸï¸ Build Architecture Splits (High Performance)
    needs: prepare_environment
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      # Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø® Ù…Ù†ÙØµÙ„Ø© (Split per ABI)
      # Ù‡Ø°Ø§ ÙŠÙ†ØªØ¬ 3 Ù…Ù„ÙØ§Øª APK (ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù„Ø¬)
      - name: ğŸ”¨ Build Split APKs
        run: |
          flutter build apk --debug --split-per-abi

      - name: ğŸ“¤ Upload ARM64-v8a (Modern Phones)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-ARM64-Debug
          path: build/app/outputs/flutter-apk/app-arm64-v8a-debug.apk

      - name: ğŸ“¤ Upload ARM-v7a (Older Phones)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-ARMv7-Debug
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-debug.apk

      - name: ğŸ“¤ Upload x86_64 (Emulators)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-x64-Debug
          path: build/app/outputs/flutter-apk/app-x86_64-debug.apk

  # ----------------------------------------------------------------------------
  # JOB 5: NOTIFICATION & LOGGING (Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)
  # ----------------------------------------------------------------------------
  finalize_build:
    name: âœ… Finalize & Report
    needs: [build_apk_debug_universal, build_apk_splits]
    runs-on: ubuntu-latest
    if: always() # ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ø¥Ø¹Ø·Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
    steps:
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "=========================================="
          echo "ğŸš€ LIQUID SNAP BUILD COMPLETE"
          echo "=========================================="
          echo "Build Date: $(date)"
          echo "Flutter Version: ${{ env.FLUTTER_VERSION }}"
          echo "Build Type: Debug (Developer Edition)"
          echo "Target Android SDK: ${{ env.ANDROID_COMPILE_SDK }}"
          echo "=========================================="

      - name: ğŸ“¥ Upload Build Logs (For Debugging)
        if: failure() # ÙŠØ±ÙØ¹ Ø§Ù„Ù„ÙˆØ¬ ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        uses: actions/upload-artifact@v4
        with:
          name: Build-Failure-Logs
          path: /home/runner/work/_temp/_github_workflow/event.json

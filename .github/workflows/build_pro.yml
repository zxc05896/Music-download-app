name: ğŸš€ LiquidSnap Ultimate CI/CD Pipeline (Pro Max 2026)

# ==============================================================================
# ğŸ¯ TRIGGERS (Ù…ØªÙ‰ ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ­Ø´ØŸ)
# ==============================================================================
on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

# ==============================================================================
# âš™ï¸ GLOBAL CONFIGURATION (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©)
# ==============================================================================
env:
  # ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ«Ø¨ÙŠØª Ø±Ù‚Ù… Ù‚Ø¯ÙŠÙ…
  FLUTTER_CHANNEL: 'stable' 
  JAVA_VERSION: '17' # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù€ Gradle 9
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  PROPERTIES_PATH: './android/local.properties'

# ==============================================================================
# ğŸ—ï¸ JOBS (Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØ©)
# ==============================================================================
jobs:
  
  # ----------------------------------------------------------------------------
  # JOB 1: QUALITY ASSURANCE (ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ÙƒÙˆØ¯)
  # ----------------------------------------------------------------------------
  analyze_and_test:
    name: ğŸ” Code Analysis & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: âš¡ Setup Flutter (Latest Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true
          # âš ï¸ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© flutter-version Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø« (3.27+)

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ§ Analyze Code (Static Analysis)
        run: flutter analyze
        continue-on-error: true 

      - name: ğŸ§ª Run Unit Tests (Optional)
        run: flutter test || echo "No tests found, skipping..."

  # ----------------------------------------------------------------------------
  # JOB 2: BUILD ENVIRONMENT PREP (ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØµØ§Ø±Ù…Ø©)
  # ----------------------------------------------------------------------------
  prepare_environment:
    name: ğŸ› ï¸ Prepare Android Environment
    needs: analyze_and_test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: ğŸ§¹ Deep Clean Project
        run: |
          flutter clean
          rm -rf build
          rm -rf android/.gradle
          flutter pub get

      - name: ğŸ“„ Create local.properties
        run: |
          echo "flutter.sdk=$FLUTTER_ROOT" > ${{ env.PROPERTIES_PATH }}
          echo "sdk.dir=$ANDROID_HOME" >> ${{ env.PROPERTIES_PATH }}
          echo "flutter.buildMode=debug" >> ${{ env.PROPERTIES_PATH }}

  # ----------------------------------------------------------------------------
  # JOB 3: BUILD THE BEAST (Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø©)
  # ----------------------------------------------------------------------------
  build_apk_debug_universal:
    name: ğŸ—ï¸ Build Universal Debug APK (The Beast)
    needs: prepare_environment
    runs-on: ubuntu-latest
    timeout-minutes: 60 
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Universal APK (Debug Mode)
        run: |
          flutter build apk --debug --no-shrink

      - name: ğŸ“¤ Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-Universal-Debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 14

  # ----------------------------------------------------------------------------
  # JOB 4: BUILD OPTIMIZED SPLITS (Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø® Ù…ØªØ®ØµØµØ© Ù„ÙƒÙ„ Ù…Ø¹Ø§Ù„Ø¬)
  # ----------------------------------------------------------------------------
  build_apk_splits:
    name: ğŸï¸ Build Architecture Splits (High Performance)
    needs: prepare_environment
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: âš¡ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Split APKs
        run: |
          flutter build apk --debug --split-per-abi

      - name: ğŸ“¤ Upload ARM64-v8a (Modern Phones)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-ARM64-Debug
          path: build/app/outputs/flutter-apk/app-arm64-v8a-debug.apk

      - name: ğŸ“¤ Upload ARM-v7a (Older Phones)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-ARMv7-Debug
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-debug.apk

      - name: ğŸ“¤ Upload x86_64 (Emulators)
        uses: actions/upload-artifact@v4
        with:
          name: LiquidSnap-x64-Debug
          path: build/app/outputs/flutter-apk/app-x86_64-debug.apk

  # ----------------------------------------------------------------------------
  # JOB 5: NOTIFICATION & LOGGING (Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)
  # ----------------------------------------------------------------------------
  finalize_build:
    name: âœ… Finalize & Report
    needs: [build_apk_debug_universal, build_apk_splits]
    runs-on: ubuntu-latest
    if: always() 
    steps:
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "=========================================="
          echo "ğŸš€ LIQUID SNAP BUILD COMPLETE"
          echo "=========================================="
          echo "Build Date: $(date)"
          echo "Target Android SDK: ${{ env.ANDROID_COMPILE_SDK }}"
          echo "=========================================="

      - name: ğŸ“¥ Upload Build Logs (For Debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Failure-Logs
          path: /home/runner/work/_temp/_github_workflow/event.json
